<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–€çˆ¾æ–‡ï¼šæ•¸é‡å£“åˆ¶ v5.1.1</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; touch-action: manipulation; color: white; }
        #game-stage { position: relative; width: 100vw; height: 100vh; background: radial-gradient(circle, #1a1a2e 0%, #000 100%); overflow: hidden; }
        #safe-zone { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; margin: -25px 0 0 -25px; z-index: 10; background-image: url('safe.jpg'); background-size: cover; border-radius: 50%; border: 2px solid #f1c40f; box-shadow: 0 0 15px #f1c40f; transition: all 0.3s; }
        #safe-zone.shielded { border: 5px solid #3498db; box-shadow: 0 0 30px #3498db; transform: scale(1.2); }

        .enemy { position: absolute; border-radius: 50%; background-image: url('12672.jpg'); background-size: cover; z-index: 5; }
        .t-normal { border: 2px solid #fff; }
        .t-speed { border: 2px solid #3498db; }
        .t-heal { border: 3px solid #2ecc71; box-shadow: 0 0 15px #2ecc71; }
        .t-coward { border: 3px solid #f39c12; }
        .t-build { border: 3px solid #a36629; }
        .t-greed { border: 4px solid #e91e63; box-shadow: 0 0 20px #e91e63; }
        .t-sniper { border: 3px solid #ff0000; box-shadow: 0 0 10px #ff0000; }
        .t-boss { border: 6px solid #ff4757; box-shadow: 0 0 40px #ff4757; }
        .t-clone { border: 1px solid #ff4757; opacity: 0.7; }
        .hide-border { border: none !important; box-shadow: none !important; }

        .laser { position: absolute; height: 2px; background: rgba(255, 0, 0, 0.4); transform-origin: left center; z-index: 4; pointer-events: none; display: none; }
        .laser-charge { animation: blink 0.5s infinite; background: rgba(255, 0, 0, 1); height: 3px; display: block; }
        @keyframes blink { 50% { opacity: 0; } }

        #ui-layer { position: absolute; top: 15px; width: 100%; text-align: center; pointer-events: none; z-index: 20; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        .guide { width: 100%; max-width: 450px; background: #222; padding: 15px; border-radius: 15px; font-size: 11px; margin: 10px 0; text-align: left; }
        .guide-item { display: flex; align-items: center; margin-bottom: 6px; border-bottom: 1px solid #333; padding-bottom: 4px; }
        .g-icon { width: 22px; height: 22px; border-radius: 50%; background-image: url('12672.jpg'); background-size: cover; margin-right: 10px; flex-shrink: 0; }
        
        .vol-control { margin: 10px 0; background: #333; padding: 10px; border-radius: 10px; width: 80%; max-width: 300px; text-align: center; pointer-events: auto; }
        .btn { padding: 12px 60px; background: #f1c40f; color: #000; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; }
        #boss-hp-bar { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); width: 70%; height: 12px; background: #333; display: none; z-index: 30; border: 2px solid #fff; border-radius: 6px; }
        #boss-hp-inner { width: 100%; height: 100%; background: #ff4757; transition: width 0.2s; }
    </style>
</head>
<body>

    <div id="game-stage">
        <div id="ui-layer">
            <div id="hp-display"><span class="hp-heart">â¤ï¸</span><span class="hp-heart">â¤ï¸</span><span class="hp-heart">â¤ï¸</span></div>
            <div id="score-text">åˆ†æ•¸: 0</div>
            <div id="timer-text">æ™‚é–“: 0s</div>
        </div>
        <div id="skill-announcement" style="position:fixed; top:130px; width:100%; text-align:center; color:#ff4757; font-weight:bold; font-size:20px; z-index:40;"></div>
        <div id="boss-hp-bar"><div id="boss-hp-inner"></div></div>
        <div id="safe-zone"></div>
    </div>

    <div id="start-ui" class="overlay">
        <h2 style="color:#f1c40f; margin: 5px 0;">å–€çˆ¾æ–‡ä¿è¡›æˆ° v5.1.1</h2>
        <div class="vol-control">
            <label>ğŸ”Š éŸ³é‡: <span id="vol-pct">50</span>%</label><br>
            <input type="range" id="global-vol" min="0" max="1" step="0.05" value="0.5" style="width:100%">
        </div>
        <div class="guide">
            <div class="guide-item"><div class="g-icon" style="border:2px solid #ff0000"></div><div><b>ç‹™æ“Šæ‰‹ (ç´…):</b> é€²å…¥å®šé»å¾Œç„æº–ï¼Œ3ç§’å¾Œå°„æ“Šæ‰£è¡€ã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #ff4757; width:28px; height:28px;"></div><div><b>å–€çˆ¾æ–‡çš‡ (å·¨ç´…):</b> 90ç§’ç™»å ´ï¼Œæ¯12ç§’éš¨æ©Ÿç™¼å‹•æ¬Šèƒ½æŠ€èƒ½ã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #2ecc71"></div><div><b>è£œè¡€å¤©ä½¿ (ç¶ ):</b> æ’æ“Šæ ¸å¿ƒå›è¡€ã€‚æ³¨æ„ï¼šçš‡åˆ†èº«æ’åˆ°æœƒå›çš‡çš„è¡€ï¼</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #f39c12"></div><div><b>è†½å°è€… (æ©˜):</b> è¢«é»æ“Šæœƒæ’¤é€€ï¼Œæ’¤é€€ä¸­è¢«é»æ“Šæœƒå†æ¬¡å›é ­ã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #a36629"></div><div><b>å»ºç¯‰ (è¤):</b> æ“Šæ®ºå¾Œæ ¸å¿ƒç²å¾—ã€Œè—è‰²è­·ç›¾ã€ã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #e91e63"></div><div><b>è²ªå©ª (ç²‰):</b> æ“Šæ®ºæ¸…é™¤é›œé­š (ä¸å«çš‡èˆ‡å¤©ä½¿)ã€‚</div></div>
        </div>
        <button class="btn" onclick="startGame()">é–‹å§‹å°æ±º</button>
    </div>

    <div id="end-ui" class="overlay" style="display:none; justify-content:center;">
        <h1 id="end-title">ä»»å‹™çµæŸ</h1>
        <button class="btn" onclick="location.reload()">é‡æ–°æ•´å‚™</button>
    </div>

    <audio id="bgm" src="bgm.mp3" loop></audio>
    <audio id="hit-sound" src="hit.mp3"></audio>

    <script>
        let score = 0, playerHP = 3, isLive = false, hasShield = false, startTime, spawnRate = 1200, bossActive = false, bossRef = null;
        const stage = document.getElementById('game-stage');
        const bgm = document.getElementById('bgm');
        const hitSound = document.getElementById('hit-sound');
        const volSlider = document.getElementById('global-vol');

        const savedVol = localStorage.getItem('calvin_vol') || 0.5;
        volSlider.value = savedVol;
        document.getElementById('vol-pct').innerText = Math.round(savedVol * 100);
        volSlider.oninput = () => {
            const v = volSlider.value;
            document.getElementById('vol-pct').innerText = Math.round(v * 100);
            bgm.volume = v; hitSound.volume = v;
            localStorage.setItem('calvin_vol', v);
        };

        const TYPES = [
            { id:'normal', hp:1, speed:1.1, weight:40, class:'t-normal', size:60 },
            { id:'speed', hp:1, speed:1.8, weight:15, class:'t-speed', size:50 }, 
            { id:'coward', hp:1, speed:1.4, weight:12, class:'t-coward', size:60 },
            { id:'build', hp:1, speed:0.8, weight:6, class:'t-build', size:65 },
            { id:'greed', hp:1, speed:0.6, weight:4, class:'t-greed', size:80 },
            { id:'sniper', hp:1, speed:1.0, weight:10, class:'t-sniper', size:55 }
        ];

        function startGame() {
            bgm.volume = volSlider.value; hitSound.volume = volSlider.value;
            bgm.play().catch(()=>{});
            document.getElementById('start-ui').remove();
            isLive = true; startTime = Date.now();
            spawnController();
            updateStats();
            setInterval(spawnHealer, 25000); 
        }

        function updateStats() {
            if(!isLive) return;
            const sec = Math.floor((Date.now()-startTime)/1000);
            document.getElementById('timer-text').innerText = `æ™‚é–“: ${sec}s`;
            
            // éš¨æ™‚é–“æé«˜ç”Ÿæˆé »ç‡ï¼Œä¸å†æé«˜é€Ÿåº¦
            spawnRate = Math.max(300, 1200 - (sec * 12)); 
            
            if (sec >= 90 && !bossActive) spawnBoss();
            setTimeout(updateStats, 1000);
        }

        function clearMinions() {
            document.querySelectorAll('.enemy').forEach(el => {
                if(!el.classList.contains('t-boss') && !el.classList.contains('t-heal')) {
                    if(el.laser) el.laser.remove();
                    el.remove();
                }
            });
        }

        function spawnBoss() {
            bossActive = true; clearMinions();
            document.getElementById('boss-hp-bar').style.display = 'block';
            bossRef = createEnemy(innerWidth/2, -250, { id:'boss', hp:30, maxHp:30, speed:0.04, size:220, class:'t-boss' });
            setInterval(triggerBossSkill, 12000);
        }

        function triggerBossSkill() {
            if(!isLive || !bossActive || !bossRef) return;
            const skills = ['åˆ†èº«', 'ç‹™æ“Šéƒ¨éšŠ', 'ç²‰çµ²åœ˜', 'å—¨å„ä½'];
            const skill = skills[Math.floor(Math.random() * skills.length)];
            const ann = document.getElementById('skill-announcement');
            ann.innerText = `çš‡ä¹‹æ¬Šèƒ½ï¼š${skill}`;
            setTimeout(() => ann.innerText = '', 3000);

            if(skill === 'åˆ†èº«') {
                for(let i=0; i<10; i++) createEnemy(bossRef.state.x, bossRef.state.y, { id:'clone', hp:1, speed:1.5, size:100, class:'t-clone' });
            } else if(skill === 'ç‹™æ“Šéƒ¨éšŠ') {
                for(let i=0; i<10; i++) setTimeout(() => createEnemy(undefined, undefined, TYPES.find(t=>t.id==='sniper')), i*300);
            } else if(skill === 'ç²‰çµ²åœ˜') {
                const randomType = TYPES[Math.floor(Math.random()*TYPES.length)];
                for(let i=0; i<15; i++) setTimeout(() => createEnemy(bossRef.state.x, bossRef.state.y, randomType), i*150);
            } else if(skill === 'å—¨å„ä½') {
                document.querySelectorAll('.enemy').forEach(el => el.classList.add('hide-border'));
                setTimeout(() => document.querySelectorAll('.enemy').forEach(el => el.classList.remove('hide-border')), 4000);
            }
        }

        function createEnemy(x, y, forcedType = null) {
            if(!isLive) return null;
            let type = forcedType;
            if(!type) {
                const totalWeight = TYPES.reduce((a,b)=>a+b.weight, 0);
                let r = Math.random() * totalWeight, curr = 0;
                for(let t of TYPES) { curr += t.weight; if(r <= curr) { type = t; break; } }
            }

            const el = document.createElement('div');
            el.className = `enemy ${type.class}`;
            el.style.width = el.style.height = type.size + 'px';
            
            // åˆå§‹åº§æ¨™è™•ç†
            if(x === undefined) {
                let side = Math.floor(Math.random()*4);
                if(side===0){ x=Math.random()*innerWidth; y=-100; }
                else if(side===1){ x=innerWidth+100; y=Math.random()*innerHeight; }
                else if(side===2){ x=Math.random()*innerWidth; y=innerHeight+100; }
                else { x=-100; y=Math.random()*innerHeight; }
            }

            const state = { 
                x, y, 
                hp: type.hp || 1, 
                speed: type.speed || 1.0, 
                id: type.id, 
                radius: type.size/2, 
                isEscaping: false,
                targetPoint: type.id === 'sniper' ? { x: Math.random()*(innerWidth-100)+50, y: Math.random()*(innerHeight-100)+50 } : null
            };
            el.state = state;

            const hit = (e) => {
                e.preventDefault();
                if(state.id === 'heal') { el.remove(); return; }
                hitSound.currentTime=0; hitSound.play();
                if(state.id === 'coward') { state.isEscaping = !state.isEscaping; el.style.opacity = state.isEscaping ? "0.6" : "1"; return; }

                state.hp--;
                if(state.id === 'boss') document.getElementById('boss-hp-inner').style.width = (state.hp/30)*100 + '%';
                if(state.hp <= 0) {
                    if(state.id === 'build') applyShield();
                    if(state.id === 'greed') { score += 500; clearMinions(); }
                    score += (state.id === 'boss' ? 5000 : 10);
                    document.getElementById('score-text').innerText = `åˆ†æ•¸: ${score}`;
                    if(state.id === 'boss') victory();
                    if(el.laser) el.laser.remove();
                    el.remove();
                }
            };
            el.addEventListener('touchstart', hit); el.addEventListener('mousedown', hit);
            stage.appendChild(el);

            if(state.id === 'sniper') runSniperLogic(el, state);
            else runMoveLogic(el, state);
            return el;
        }

        function runMoveLogic(el, state) {
            const move = () => {
                if(!isLive || !el.parentNode) return;
                const tx = innerWidth/2, ty = innerHeight/2;
                let dx = tx - state.x, dy = ty - state.y, d = Math.sqrt(dx*dx+dy*dy);
                
                if(d < (state.id === 'boss' ? 85 : 25)) { 
                    if(state.id === 'heal') healPlayer(); 
                    else if(state.id === 'clone') { if(bossRef) bossRef.state.hp = Math.min(30, bossRef.state.hp+1); }
                    else takeDamage();
                    el.remove(); return; 
                }

                let vx, vy;
                if(state.id === 'coward' && state.isEscaping) {
                    vx = -(dx/d) * state.speed * 2; vy = -(dy/d) * state.speed * 2;
                    if(state.x < -100 || state.x > innerWidth+100 || state.y < -100 || state.y > innerHeight+100) { el.remove(); return; }
                } else {
                    vx = (dx/d) * state.speed; vy = (dy/d) * state.speed;
                }

                state.x += vx; state.y += vy;
                el.style.left = (state.x - state.radius)+'px'; el.style.top = (state.y - state.radius)+'px';
                requestAnimationFrame(move);
            };
            requestAnimationFrame(move);
        }

        function runSniperLogic(el, state) {
            const laser = document.createElement('div');
            laser.className = 'laser';
            stage.appendChild(laser);
            el.laser = laser;

            const moveAndSnipe = () => {
                if(!isLive || !el.parentNode) { laser.remove(); return; }
                
                // 1. è·‘å‘ç‹™æ“Šé»
                let dx = state.targetPoint.x - state.x, dy = state.targetPoint.y - state.y;
                let d = Math.sqrt(dx*dx+dy*dy);

                if(d > 5) {
                    state.x += (dx/d) * state.speed * 2;
                    state.y += (dy/d) * state.speed * 2;
                    el.style.left = state.x - state.radius + 'px';
                    el.style.top = state.y - state.radius + 'px';
                    requestAnimationFrame(moveAndSnipe);
                } else {
                    // 2. æŠµé”å¾Œæ¶æ§
                    startLaserCycle(el, state, laser);
                }
            };
            requestAnimationFrame(moveAndSnipe);
        }

        async function startLaserCycle(el, state, laser) {
            const tx = innerWidth/2, ty = innerHeight/2;
            while(isLive && el.parentNode) {
                laser.style.display = 'block';
                laser.style.left = state.x + 'px';
                laser.style.top = state.y + 'px';
                laser.style.width = Math.sqrt((tx-state.x)**2 + (ty-state.y)**2) + 'px';
                laser.style.transform = `rotate(${Math.atan2(ty - state.y, tx - state.x)}rad)`;
                
                await new Promise(r => setTimeout(r, 1000));
                if(!el.parentNode) break;
                laser.classList.add('laser-charge');
                await new Promise(r => setTimeout(r, 2000));
                
                if(isLive && el.parentNode) {
                    takeDamage();
                    laser.classList.remove('laser-charge');
                    laser.style.display = 'none';
                    // é‡æ–°æ›é»
                    state.targetPoint = { x: Math.random()*(innerWidth-100)+50, y: Math.random()*(innerHeight-100)+50 };
                    runSniperLogic(el, state); // é‡æ–°é€²å…¥ç§»å‹•é‚è¼¯
                    return; 
                }
            }
            laser.remove();
        }

        function spawnHealer() { if(isLive) createEnemy(undefined, undefined, { id:'heal', hp:1, speed:0.6, size:35, class:'t-heal' }); }
        function applyShield() { hasShield = true; document.getElementById('safe-zone').classList.add('shielded'); }
        function healPlayer() { if(playerHP < 3) { document.getElementsByClassName('hp-heart')[playerHP].style.opacity = "1"; playerHP++; } }
        function takeDamage() {
            if(hasShield) { hasShield = false; document.getElementById('safe-zone').classList.remove('shielded'); return; }
            playerHP--;
            if(document.getElementsByClassName('hp-heart')[playerHP]) document.getElementsByClassName('hp-heart')[playerHP].style.opacity = "0.2";
            if(playerHP <= 0) endGame();
        }
        function spawnController() { if(isLive) { createEnemy(); setTimeout(spawnController, spawnRate); } }
        function victory() { isLive = false; document.getElementById('end-title').innerText = "ğŸ† çš‡å·²é§•å´©ï¼"; document.getElementById('end-ui').style.display='flex'; }
        function endGame() { isLive = false; document.getElementById('end-title').innerText = "ğŸš« é˜²ç·šå´©æ½°"; document.getElementById('end-ui').style.display='flex'; }
    </script>
</body>
</html>
