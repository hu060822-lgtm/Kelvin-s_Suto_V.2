<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–€çˆ¾æ–‡ï¼šä¸‰å‘½é˜²ç¦¦æˆ° v4.3</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; touch-action: manipulation; color: white; }
        #game-stage { position: relative; width: 100vw; height: 100vh; background: radial-gradient(circle, #1a1a2e 0%, #000 100%); overflow: hidden; }
        
        /* ç¸®å°å¾Œçš„å®‰å…¨å€ */
        #safe-zone { 
            position: absolute; top: 50%; left: 50%; 
            width: 50px; height: 50px; margin: -25px 0 0 -25px; 
            z-index: 10; background-image: url('safe.jpg'); background-size: cover; 
            border-radius: 50%; border: 2px solid #f1c40f; box-shadow: 0 0 15px #f1c40f;
        }

        .enemy { position: absolute; border-radius: 50%; background-size: cover; background-position: center; z-index: 5; transition: transform 0.1s, opacity 0.2s; }
        .t-normal { border: 2px solid #fff; }
        .t-tank { border: 4px solid #f1c40f; }
        .t-speed { border: 2px solid #3498db; }
        .t-ghost { opacity: 0.3; }
        .t-split { border: 2px solid #2ecc71; }
        .t-blink { border: 2px solid #9b59b6; } /* ç¬ç§»ç¨® */
        .t-reverse { border: 2px solid #e67e22; } /* æ™ƒå‹•ç¨® */
        .t-boss { border: 6px solid #ff4757; box-shadow: 0 0 40px #ff4757; }

        #ui-layer { position: absolute; top: 15px; width: 100%; text-align: center; pointer-events: none; z-index: 20; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        
        /* åˆå§‹åœ–é‘‘ */
        .guide { width: 100%; max-width: 350px; background: #222; padding: 15px; border-radius: 15px; font-size: 13px; margin: 15px 0; line-height: 1.5; }
        .guide-item { display: flex; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .g-img { width: 30px; height: 30px; border-radius: 50%; background-image: url('12672.jpg'); background-size: cover; margin-right: 10px; flex-shrink: 0; }
        
        .hp-heart { font-size: 24px; color: #ff4757; margin: 0 5px; }
        .btn { padding: 12px 50px; background: #f1c40f; color: #000; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; }
        
        #boss-hp-bar { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); width: 70%; height: 8px; background: #333; border-radius: 4px; display: none; }
        #boss-hp-inner { width: 100%; height: 100%; background: #ff4757; border-radius: 4px; transition: width 0.2s; }
    </style>
</head>
<body>

    <div id="game-stage">
        <div id="ui-layer">
            <div id="hp-display"><span class="hp-heart">â¤ï¸</span><span class="hp-heart">â¤ï¸</span><span class="hp-heart">â¤ï¸</span></div>
            <div id="score-text">åˆ†æ•¸: 0</div>
            <div id="timer-text">æ™‚é–“: 0s</div>
        </div>
        <div id="boss-hp-bar"><div id="boss-hp-inner"></div></div>
        <div id="safe-zone"></div>
    </div>

    <div id="start-ui" class="overlay">
        <h1 style="color:#f1c40f; margin: 10px 0;">å–€çˆ¾æ–‡ä¿è¡›æˆ° v4.3</h1>
        <div class="guide">
            <div class="guide-item"><div class="g-img" style="border:1px solid #fff"></div><div><b>æ™®é€šï¼š</b>æœƒè›‡è¡Œå‰é€²ã€‚</div></div>
            <div class="guide-item"><div class="g-img" style="border:2px solid #f1c40f"></div><div><b>å¦å…‹ï¼š</b>è¡€åšï¼Œé»æ“Š 4 æ¬¡ã€‚</div></div>
            <div class="guide-item"><div class="g-img" style="border:1px solid #3498db"></div><div><b>è¡åˆºï¼š</b>é€Ÿåº¦æ¥µå¿«ã€‚</div></div>
            <div class="guide-item"><div class="g-img" style="border:1px solid #2ecc71"></div><div><b>åˆ†è£‚ï¼š</b>æ“Šæ®ºå¾Œæœƒä¸€åˆ†ç‚ºäºŒã€‚</div></div>
            <div class="guide-item"><div class="g-img" style="border:1px solid #9b59b6"></div><div><b>ç¬ç§»ï¼š</b>æœƒéš±èº«ä¸¦è·³èºè·é›¢ã€‚</div></div>
            <div class="guide-item"><div class="g-img" style="border:1px solid #e67e22"></div><div><b>æ™ƒå‹•ï¼š</b>å‰é€²å¾Œé€€é›£ä»¥æ‰æ‘¸ã€‚</div></div>
            <div class="guide-item"><div class="g-img" style="border:2px solid #ff4757"></div><div><b>çš‡ï¼š</b>90ç§’å‡ºç¾ï¼Œæœƒå¬å–šè¡åˆºæ€ªã€‚</div></div>
        </div>
        <p style="font-size:12px; color:#aaa;">ä½ æœ‰ 3 æ¢å‘½ï¼Œå®ˆè­·æ ¸å¿ƒï¼</p>
        <button class="btn" onclick="startGame()">é–‹å§‹ä½œæˆ°</button>
    </div>

    <div id="end-ui" class="overlay" style="display:none; justify-content:center;">
        <h1 id="end-title">éŠæˆ²çµæŸ</h1>
        <p id="final-stats"></p>
        <button class="btn" onclick="location.reload()">é‡æ–°æ•´å‚™</button>
    </div>

    <audio id="bgm" src="bgm.mp3" loop></audio>
    <audio id="hit-sound" src="hit.mp3"></audio>

    <script>
        let score = 0, playerHP = 3, isLive = false, startTime, baseSpeed = 0.8, spawnRate = 1500, bossActive = false;
        const stage = document.getElementById('game-stage');
        const bgm = document.getElementById('bgm');
        const hitSound = document.getElementById('hit-sound');

        const TYPES = [
            { id:'normal', hp:1, speed:1.0, size:60, weight:50, class:'t-normal' },
            { id:'tank', hp:4, speed:0.4, size:110, weight:15, class:'t-tank' },
            { id:'speed', hp:1, speed:1.8, size:40, weight:15, class:'t-speed' },
            { id:'split', hp:1, speed:0.8, size:65, weight:10, class:'t-split' },
            { id:'blink', hp:1, speed:0.9, size:60, weight:10, class:'t-blink' },
            { id:'reverse', hp:1, speed:0.9, size:60, weight:10, class:'t-reverse' }
        ];

        function startGame() {
            document.getElementById('start-ui').remove();
            isLive = true; startTime = Date.now();
            bgm.play().catch(()=>{});
            spawnController();
            updateStats();
        }

        function updateStats() {
            if(!isLive) return;
            const sec = Math.floor((Date.now()-startTime)/1000);
            document.getElementById('timer-text').innerText = `æ™‚é–“: ${sec}s`;
            if (sec >= 90 && !bossActive) spawnBoss();
            // é€Ÿåº¦æˆé•·å¤§å¹…èª¿é™
            baseSpeed = 0.8 + (sec/20);
            spawnRate = Math.max(450, 1500 - (sec*8));
            setTimeout(updateStats, 1000);
        }

        function spawnBoss() {
            bossActive = true;
            document.getElementById('boss-hp-bar').style.display = 'block';
            createEnemy(innerWidth/2, -200, { id:'boss', hp:40, speed:0.15, size:220, class:'t-boss' });
        }

        function createEnemy(x, y, forcedType = null) {
            if(!isLive) return;
            let type = forcedType;
            if(!type) {
                const totalWeight = TYPES.reduce((a,b)=>a+b.weight, 0);
                let r = Math.random() * totalWeight, curr = 0;
                for(let t of TYPES) { curr += t.weight; if(r <= curr) { type = t; break; } }
            }

            const el = document.createElement('div');
            el.className = `enemy ${type.class}`;
            el.style.backgroundImage = "url('12672.jpg')";
            el.style.width = el.style.height = type.size + 'px';
            
            if(x === undefined) {
                let side = Math.floor(Math.random()*4);
                if(side===0){ x=Math.random()*innerWidth; y=-150; }
                else if(side===1){ x=innerWidth+150; y=Math.random()*innerHeight; }
                else if(side===2){ x=Math.random()*innerWidth; y=innerHeight+150; }
                else { x=-150; y=Math.random()*innerHeight; }
            }

            const state = { x, y, hp: type.hp, maxHp: type.hp, speed: baseSpeed * (type.speed || 1), seed: Math.random()*10, id: type.id, radius: type.size/2 };
            
            const hit = (e) => {
                e.preventDefault(); hitSound.currentTime=0; hitSound.play();
                state.hp--;
                el.style.transform = "scale(0.85)";
                setTimeout(()=>el.style.transform="scale(1)", 50);

                if(state.id === 'boss') {
                    const pct = (state.hp / state.maxHp) * 100;
                    document.getElementById('boss-hp-inner').style.width = pct + '%';
                }

                if(state.hp <= 0) {
                    if(state.id === 'split') {
                        createEnemy(state.x+20, state.y, TYPES[0]);
                        createEnemy(state.x-20, state.y, TYPES[0]);
                    }
                    score += (state.id === 'boss' ? 2000 : 10);
                    document.getElementById('score-text').innerText = `åˆ†æ•¸: ${score}`;
                    if(state.id === 'boss') victory();
                    el.remove();
                }
            };
            el.addEventListener('touchstart', hit); el.addEventListener('mousedown', hit);
            stage.appendChild(el);

            let t = 0;
            const move = () => {
                if(!isLive || !el.parentNode) return;
                const tx = innerWidth/2, ty = innerHeight/2;
                let dx = tx - state.x, dy = ty - state.y, d = Math.sqrt(dx*dx+dy*dy);
                
                // ç¢°æ’æª¢æ¸¬ï¼šç¢°åˆ°å®‰å…¨å€
                if(d < (state.id === 'boss' ? 60 : 25)) {
                    takeDamage();
                    el.remove();
                    return;
                }

                let currentSpeed = state.speed;

                // ç‰¹è‰²æ€ªæ©Ÿåˆ¶é‡è£½
                if(state.id === 'normal' && d > 100) { // åªæœ‰æ™®é€šæ€ªæœƒè›‡è¡Œ
                    const wave = Math.sin(t*0.08 + state.seed) * 1.5;
                    state.x += -(dy/d)*wave; state.y += (dx/d)*wave;
                }
                else if(state.id === 'blink') { // ç¬ç§»ç¨®ï¼šéš±èº«ä¸¦è·³èº
                    if(t % 120 > 80) { el.style.opacity = "0.1"; currentSpeed *= 2; }
                    else { el.style.opacity = "1"; }
                }
                else if(state.id === 'reverse') { // æ™ƒå‹•ç¨®ï¼šå½ˆç°§å‰é€²
                    currentSpeed *= (1 + Math.sin(t*0.15)*1.2);
                }
                else if(state.id === 'boss' && t % 180 === 0) { // Boss ç”¢åµ
                    createEnemy(state.x, state.y, TYPES[2]);
                }

                state.x += (dx/d) * currentSpeed;
                state.y += (dy/d) * currentSpeed;
                el.style.left = (state.x - state.radius)+'px';
                el.style.top = (state.y - state.radius)+'px';
                t++; requestAnimationFrame(move);
            };
            requestAnimationFrame(move);
        }

        function takeDamage() {
            playerHP--;
            const hearts = document.getElementsByClassName('hp-heart');
            if(hearts[playerHP]) hearts[playerHP].style.opacity = "0.2";
            
            // å®‰å…¨å€å—å‚·å‹•ç•«
            const sz = document.getElementById('safe-zone');
            sz.style.backgroundColor = "rgba(255, 71, 87, 0.5)";
            setTimeout(()=>sz.style.backgroundColor="transparent", 200);

            if(playerHP <= 0) endGame();
        }

        function spawnController() {
            if(!isLive) return;
            createEnemy();
            setTimeout(spawnController, spawnRate);
        }

        function victory() {
            isLive = false;
            document.getElementById('end-title').innerText = "ğŸ† å®ˆè­·æˆåŠŸï¼";
            document.getElementById('end-ui').style.display = 'flex';
            document.getElementById('final-stats').innerText = `æœ€çµ‚åˆ†æ•¸: ${score}`;
        }

        function endGame() {
            if(!isLive) return;
            isLive = false;
            document.getElementById('end-ui').style.display = 'flex';
            document.getElementById('final-stats').innerText = `åˆ†æ•¸: ${score} | ç”Ÿå­˜: ${Math.floor((Date.now()-startTime)/1000)}s`;
        }
    </script>
</body>
</html>
