<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å–€çˆ¾æ–‡ï¼šçš‡ä¹‹é™è‡¨ v4.9</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; touch-action: manipulation; color: white; }
        #game-stage { position: relative; width: 100vw; height: 100vh; background: radial-gradient(circle, #1a1a2e 0%, #000 100%); overflow: hidden; }
        
        #safe-zone { position: absolute; top: 50%; left: 50%; width: 50px; height: 50px; margin: -25px 0 0 -25px; z-index: 10; background-image: url('safe.jpg'); background-size: cover; border-radius: 50%; border: 2px solid #f1c40f; box-shadow: 0 0 15px #f1c40f; transition: all 0.3s; }
        #safe-zone.shielded { border: 5px solid #3498db; box-shadow: 0 0 30px #3498db; transform: scale(1.2); }

        /* æ•µäººæ¨£å¼æ¸…å–® */
        .enemy { position: absolute; border-radius: 50%; background-image: url('12672.jpg'); background-size: cover; background-position: center; z-index: 5; }
        .t-normal { border: 2px solid #fff; }
        .t-tank { border: 4px solid #f1c40f; }
        .t-speed { border: 2px solid #3498db; }
        .t-ghost { opacity: 0.3; border: 1px solid #fff; }
        .t-split { border: 2px solid #2ecc71; }
        .t-blink { border: 2px solid #9b59b6; } 
        .t-heal { border: 3px solid #2ecc71; box-shadow: 0 0 15px #2ecc71; }
        .t-build { border: 3px solid #a36629; }
        .t-greed { border: 4px solid #e91e63; box-shadow: 0 0 20px #e91e63; }
        .t-coward { border: 3px solid #f39c12; }
        .t-boss { border: 6px solid #ff4757; box-shadow: 0 0 40px #ff4757; }
        
        /* UI å±¤ */
        #ui-layer { position: absolute; top: 15px; width: 100%; text-align: center; pointer-events: none; z-index: 20; }
        .hp-heart { font-size: 24px; color: #ff4757; margin: 0 5px; }
        
        /* éŸ³é‡æ‹‰æ¡¿ */
        #volume-panel { position: absolute; top: 10px; left: 10px; z-index: 50; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 10px; pointer-events: auto; }
        #volume-panel label { font-size: 12px; display: block; margin-bottom: 2px; }

        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: flex; flex-direction: column; align-items: center; z-index: 100; padding: 20px; box-sizing: border-box; overflow-y: auto; }
        
        /* å¼·åŒ–ç‰ˆåœ–é‘‘ */
        .guide { width: 100%; max-width: 450px; background: #222; padding: 15px; border-radius: 15px; font-size: 12px; margin: 10px 0; text-align: left; border: 1px solid #444; }
        .guide-item { display: flex; align-items: center; margin-bottom: 8px; border-bottom: 1px solid #333; padding-bottom: 6px; }
        .g-icon { width: 30px; height: 30px; border-radius: 50%; background-image: url('12672.jpg'); background-size: cover; margin-right: 12px; flex-shrink: 0; }
        .g-info b { font-size: 14px; }
        
        .btn { padding: 12px 60px; background: #f1c40f; color: #000; border: none; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        #boss-hp-bar { position: fixed; top: 80px; left: 50%; transform: translateX(-50%); width: 70%; height: 12px; background: #333; border-radius: 6px; display: none; z-index: 30; border: 2px solid #fff; }
        #boss-hp-inner { width: 100%; height: 100%; background: linear-gradient(to right, #ff4757, #ff6b81); border-radius: 4px; transition: width 0.1s; }
    </style>
</head>
<body>

    <div id="game-stage">
        <div id="volume-panel">
            <label>ğŸ”Š éŸ³é‡æ§åˆ¶</label>
            <input type="range" id="vol-slider" min="0" max="1" step="0.1" value="0.5" onchange="updateVolume(this.value)">
        </div>
        
        <div id="ui-layer">
            <div id="hp-display"><span class="hp-heart">â¤ï¸</span><span class="hp-heart">â¤ï¸</span><span class="hp-heart">â¤ï¸</span></div>
            <div id="score-text">åˆ†æ•¸: 0</div>
            <div id="timer-text">æ™‚é–“: 0s</div>
        </div>
        
        <div id="boss-hp-bar"><div id="boss-hp-inner"></div></div>
        <div id="safe-zone"></div>
    </div>

    <div id="start-ui" class="overlay">
        <h2 style="color:#f1c40f; margin: 5px 0;">å–€çˆ¾æ–‡ä¿è¡›æˆ° v4.9</h2>
        <div class="guide">
            <div class="guide-item"><div class="g-icon" style="border:2px solid #fff"></div><div class="g-info"><b style="color:#fff">æ™®é€š / è¡åˆº (ç™½/è—)</b><br>åŸºç¤æ•µäººã€‚è¡åˆºç¨®é«”å‹ç¨å¤§ä¸”é€Ÿåº¦è¼ƒå¿«ã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #2ecc71; width:22px; height:22px;"></div><div class="g-info"><b style="color:#2ecc71">è£œè¡€å¤©ä½¿ (ç¶ )</b><br>ä¸å¯æ®ºï¼è®“å®ƒæ’æ“Šæ ¸å¿ƒå¯å›è¡€ã€‚æ“Šä¸­å‰‡æ¶ˆå¤±ä¸å›è¡€ã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #f39c12"></div><div class="g-info"><b style="color:#f39c12">è†½å°è€… (æ©˜)</b><br>é»æ“Šæœƒå¾€å›é€ƒè·‘ï¼Œé€ƒè·‘æ™‚å†è¢«é»æ“Šæœƒè½‰èº«ç¹¼çºŒè¡æ“Šã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #a36629"></div><div class="g-info"><b style="color:#a36629">å»ºç¯‰ (è¤)</b><br>æ“Šæ®ºå¾Œæ ¸å¿ƒç²å¾—ã€Œè—è‰²è­·ç›¾ã€ï¼Œå¯æŠµæ“‹ä¸€æ¬¡å‚·å®³ã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #e91e63"></div><div class="g-info"><b style="color:#e91e63">è²ªå©ª (ç²‰ç´…)</b><br>é«˜åˆ†å–®ä½ã€‚æ“Šæ®ºæœƒç‚¸ç¢å…¨å ´æ™®é€šç¨®ï¼ˆå¤©ä½¿é™¤å¤–ï¼‰ã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #9b59b6"></div><div class="g-info"><b style="color:#9b59b6">å‚³é€ (ç´«) / åˆ†è£‚ (ç¶ é‚Š)</b><br>ç´«ï¼šæ­»å¾Œé‡ç”Ÿæ–¼å°è§’ã€‚ç¶ é‚Šï¼šæ­»å¾Œåˆ†è£‚ç‚ºäºŒã€‚</div></div>
            <div class="guide-item"><div class="g-icon" style="border:2px solid #ff4757; width:40px; height:40px;"></div><div class="g-info"><b style="color:#ff4757">å–€çˆ¾æ–‡çš‡ (ç´…)</b><br>90ç§’å‡ºç¾çš„é­”ç‹ã€‚è¡€åšé€Ÿæ…¢ï¼Œæœƒå¬å–šéƒ¨ä¸‹ã€‚</div></div>
        </div>
        <button class="btn" onclick="startGame()">æ¥å—æŒ‘æˆ°</button>
    </div>

    <div id="end-ui" class="overlay" style="display:none; justify-content:center;">
        <h1 id="end-title" style="color:#ff4757">é˜²ç·šå´©æ½°</h1>
        <p id="final-stats" style="font-size: 20px;"></p>
        <button class="btn" onclick="location.reload()">é‡æ–°æ•´å‚™</button>
    </div>

    <audio id="bgm" src="bgm.mp3" loop></audio>
    <audio id="hit-sound" src="hit.mp3"></audio>

    <script>
        let score = 0, playerHP = 3, isLive = false, hasShield = false, startTime, baseSpeed = 1.0, spawnRate = 1600, bossActive = false;
        const stage = document.getElementById('game-stage');
        const bgm = document.getElementById('bgm');
        const hitSound = document.getElementById('hit-sound');

        const TYPES = [
            { id:'normal', hp:1, speed:1.0, size:60, weight:40, class:'t-normal' },
            { id:'tank', hp:4, speed:0.4, size:110, weight:8, class:'t-tank' },
            { id:'speed', hp:1, speed:1.6, size:50, weight:12, class:'t-speed' }, 
            { id:'split', hp:1, speed:0.8, size:65, weight:8, class:'t-split' },
            { id:'blink', hp:1, speed:1.0, size:60, weight:8, class:'t-blink' },
            { id:'ghost', hp:1, speed:0.9, size:60, weight:8, class:'t-ghost' },
            { id:'build', hp:1, speed:0.7, size:65, weight:5, class:'t-build' },
            { id:'greed', hp:1, speed:0.5, size:80, weight:3, class:'t-greed' },
            { id:'coward', hp:1, speed:1.3, size:60, weight:8, class:'t-coward' } 
        ];

        function updateVolume(val) {
            bgm.volume = val;
            hitSound.volume = val;
        }

        function startGame() {
            updateVolume(document.getElementById('vol-slider').value);
            bgm.play().catch(()=>{});
            document.getElementById('start-ui').remove();
            isLive = true; startTime = Date.now();
            spawnController();
            updateStats();
            setInterval(spawnHealer, 30000); 
        }

        function updateStats() {
            if(!isLive) return;
            const sec = Math.floor((Date.now()-startTime)/1000);
            document.getElementById('timer-text').innerText = `æ™‚é–“: ${sec}s`;
            if (sec >= 90 && !bossActive) spawnBoss();
            baseSpeed = Math.min(2.3, 1.0 + (sec/45)); 
            spawnRate = Math.max(450, 1600 - (sec*10));
            setTimeout(updateStats, 1000);
        }

        function spawnHealer() { if(!isLive) return; createEnemy(undefined, undefined, { id:'heal', hp:1, speed:0.5, size:35, class:'t-heal' }); }

        function spawnBoss() {
            bossActive = true;
            document.getElementById('boss-hp-bar').style.display = 'block';
            createEnemy(innerWidth/2, -250, { id:'boss', hp:60, speed:0.08, size:240, class:'t-boss' });
        }

        function createEnemy(x, y, forcedType = null) {
            if(!isLive) return;
            let type = forcedType;
            if(!type) {
                const totalWeight = TYPES.reduce((a,b)=>a+b.weight, 0);
                let r = Math.random() * totalWeight, curr = 0;
                for(let t of TYPES) { curr += t.weight; if(r <= curr) { type = t; break; } }
            }

            const el = document.createElement('div');
            el.className = `enemy ${type.class}`;
            el.style.width = el.style.height = type.size + 'px';
            
            if(x === undefined) {
                let side = Math.floor(Math.random()*4);
                if(side===0){ x=Math.random()*innerWidth; y=-150; }
                else if(side===1){ x=innerWidth+150; y=Math.random()*innerHeight; }
                else if(side===2){ x=Math.random()*innerWidth; y=innerHeight+150; }
                else { x=-150; y=Math.random()*innerHeight; }
            }

            const state = { x, y, hp: type.hp, maxHp: type.hp, speed: baseSpeed * (type.speed || 1), id: type.id, radius: type.size/2, blinkCount: 0, isEscaping: false };
            
            const hit = (e) => {
                e.preventDefault();
                if(state.id === 'heal') { el.remove(); return; }
                hitSound.currentTime=0; hitSound.play();

                if(state.id === 'coward') { state.isEscaping = !state.isEscaping; el.style.opacity = state.isEscaping ? "0.6" : "1"; return; }
                if(state.id === 'blink' && state.blinkCount < 1) { state.blinkCount++; state.x = innerWidth - state.x; state.y = innerHeight - state.y; return; }

                state.hp--;
                
                // BOSS è¡€æ¢å³æ™‚åé¥‹
                if(state.id === 'boss') {
                    const pct = (state.hp / state.maxHp) * 100;
                    document.getElementById('boss-hp-inner').style.width = pct + '%';
                }

                if(state.hp <= 0) {
                    if(state.id === 'build') applyShield();
                    if(state.id === 'greed') { score += 500; document.querySelectorAll('.t-normal').forEach(n => n.remove()); }
                    if(state.id === 'split') { createEnemy(state.x+25, state.y, TYPES[0]); createEnemy(state.x-25, state.y, TYPES[0]); }
                    score += (state.id === 'boss' ? 5000 : 10);
                    document.getElementById('score-text').innerText = `åˆ†æ•¸: ${score}`;
                    if(state.id === 'boss') victory();
                    el.remove();
                }
            };
            el.addEventListener('touchstart', hit); el.addEventListener('mousedown', hit);
            stage.appendChild(el);

            const move = () => {
                if(!isLive || !el.parentNode) return;
                const tx = innerWidth/2, ty = innerHeight/2;
                let dx = tx - state.x, dy = ty - state.y, d = Math.sqrt(dx*dx+dy*dy);
                
                if(d < (state.id === 'boss' ? 85 : 25)) { 
                    if(state.id === 'heal') healPlayer(); else takeDamage();
                    el.remove(); return; 
                }

                let vx, vy;
                if(state.id === 'coward' && state.isEscaping) {
                    vx = -(dx/d) * state.speed * 2.0; vy = -(dy/d) * state.speed * 2.0;
                    if(state.x < -120 || state.x > innerWidth+120 || state.y < -120 || state.y > innerHeight+120) { el.remove(); return; }
                } else if(state.id === 'heal' || state.id === 'ghost') {
                    const rot = (state.id === 'heal') ? 0.04 : 0.05;
                    const shrink = (state.id === 'heal') ? 0.8 : state.speed;
                    const angle = Math.atan2(dy, dx) + rot;
                    vx = (tx - Math.cos(angle) * (d - shrink)) - state.x;
                    vy = (ty - Math.sin(angle) * (d - shrink)) - state.y;
                } else {
                    vx = (dx/d) * state.speed; vy = (dy/d) * state.speed;
                }

                state.x += vx; state.y += vy;
                el.style.left = (state.x - state.radius)+'px';
                el.style.top = (state.y - state.radius)+'px';
                requestAnimationFrame(move);
            };
            requestAnimationFrame(move);
        }

        function applyShield() { hasShield = true; document.getElementById('safe-zone').classList.add('shielded'); }
        function healPlayer() { if(playerHP < 3) { document.getElementsByClassName('hp-heart')[playerHP].style.opacity = "1"; playerHP++; } }
        function takeDamage() {
            if(hasShield) { hasShield = false; document.getElementById('safe-zone').classList.remove('shielded'); return; }
            playerHP--;
            if(document.getElementsByClassName('hp-heart')[playerHP]) document.getElementsByClassName('hp-heart')[playerHP].style.opacity = "0.2";
            if(playerHP <= 0) endGame();
        }
        function spawnController() { if(!isLive) return; createEnemy(); setTimeout(spawnController, spawnRate); }
        function victory() { isLive = false; showEnd("ğŸ† ä»»å‹™æˆåŠŸ"); }
        function endGame() { isLive = false; showEnd("ğŸš« ä»»å‹™å¤±æ•—"); }
        function showEnd(title) {
            const sec = Math.floor((Date.now()-startTime)/1000);
            document.getElementById('end-title').innerText = title;
            document.getElementById('final-stats').innerHTML = `å¾—åˆ†ï¼š${score}<br>ç”Ÿå­˜ï¼š${sec} ç§’`;
            document.getElementById('end-ui').style.display = 'flex';
        }
    </script>
</body>
</html>
xt').innerText = `åˆ†æ•¸: ${score}`;
                    if(state.id === 'boss') victory();
                    el.remove();
                }
            };
            el.addEventListener('touchstart', hit); el.addEventListener('mousedown', hit);
            stage.appendChild(el);

            const move = () => {
                if(!isLive || !el.parentNode) return;
                const tx = innerWidth/2, ty = innerHeight/2;
                let dx = tx - state.x, dy = ty - state.y, d = Math.sqrt(dx*dx+dy*dy);
                
                if(d < (state.id === 'boss' ? 80 : 25)) { 
                    if(state.id === 'heal') { healPlayer(); }
                    else { takeDamage(); }
                    el.remove(); return; 
                }

                let vx, vy;
                
                if(state.id === 'coward') {
                    if(state.isEscaping) {
                        vx = -(dx/d) * state.speed * 2.0; 
                        vy = -(dy/d) * state.speed * 2.0;
                        // æŠµé”é‚Šç•Œæ¶ˆå¤±
                        if(state.x < -120 || state.x > innerWidth+120 || state.y < -120 || state.y > innerHeight+120) {
                            el.remove(); return;
                        }
                    } else {
                        vx = (dx/d) * state.speed; vy = (dy/d) * state.speed;
                    }
                } else if(state.id === 'heal' || state.id === 'ghost') {
                    const rot = (state.id === 'heal') ? 0.04 : 0.05;
                    const shrink = (state.id === 'heal') ? 0.8 : state.speed;
                    const angle = Math.atan2(dy, dx) + rot;
                    const nextX = tx - Math.cos(angle) * (d - shrink);
                    const nextY = ty - Math.sin(angle) * (d - shrink);
                    vx = nextX - state.x; vy = nextY - state.y;
                } else {
                    vx = (dx/d) * state.speed; vy = (dy/d) * state.speed;
                    if(state.id === 'normal' && d > 100) {
                        const wave = Math.sin(Date.now()*0.005 + state.seed) * 1.5;
                        vx += -(dy/d)*wave; vy += (dx/d)*wave;
                    }
                }

                state.x += vx; state.y += vy;
                el.style.left = (state.x - state.radius)+'px';
                el.style.top = (state.y - state.radius)+'px';
                requestAnimationFrame(move);
            };
            requestAnimationFrame(move);
        }

        function applyShield() { hasShield = true; document.getElementById('safe-zone').classList.add('shielded'); }
        function healPlayer() {
            if(playerHP < 3) {
                const hearts = document.getElementsByClassName('hp-heart');
                hearts[playerHP].style.opacity = "1";
                playerHP++;
            }
        }
        function takeDamage() {
            if(hasShield) { hasShield = false; document.getElementById('safe-zone').classList.remove('shielded'); return; }
            playerHP--;
            const hearts = document.getElementsByClassName('hp-heart');
            if(hearts[playerHP]) hearts[playerHP].style.opacity = "0.2";
            if(playerHP <= 0) endGame();
        }
        function spawnController() { if(!isLive) return; createEnemy(); setTimeout(spawnController, spawnRate); }
        function victory() { isLive = false; showEnd("ğŸ† ä»»å‹™æˆåŠŸ"); }
        function endGame() { isLive = false; showEnd("ğŸš« ä»»å‹™å¤±æ•—"); }
        function showEnd(title) {
            const sec = Math.floor((Date.now()-startTime)/1000);
            document.getElementById('end-title').innerText = title;
            document.getElementById('final-stats').innerHTML = `å¾—åˆ†ï¼š${score}<br>ç”Ÿå­˜ï¼š${sec} ç§’`;
            document.getElementById('end-ui').style.display = 'flex';
        }
    </script>
</body>
</html>
